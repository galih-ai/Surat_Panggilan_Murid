<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>e-Letter_BK MGBK SMP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
.cert-preview-scale {
    transform-origin: top center;
}

@media (max-width: 768px) {
    .cert-preview-scale {
        transform: scale(0.45);
    }
}

@media print {
    .cert-preview-scale {
        transform: none !important;
    }
}

@media (min-width: 769px) {
    .cert-preview-scale {
        transform: scale(0.7);
    }
}
    </style>
    <style>
@page {
    size: A4;
    margin: 0;
}

#suratContent {
    width: 210mm;
    height: 330mm; /* FIX: pakai height, bukan min-height */
    margin: 0 !important;
    padding: 10mm 15mm 8mm 15mm; /* FIX: top diperkecil */
    box-sizing: border-box;
    overflow: hidden;
    background: white;
    position: relative;
}
</style>
</head>
<body class="bg-gray-100 min-h-screen overflow-x-hidden">

<div id="loginPage" class="min-h-screen flex flex-col md:flex-row bg-white overflow-hidden">
    <div class="md:w-1/2 bg-black flex items-center justify-center min-h-[300px]">
        <h1 class="text-white text-6xl font-bold tracking-tighter">
  &lt;/Gr.&gt;
</h1>
    </div>
    <div class="md:w-1/2 flex flex-col justify-center items-center p-8">
        <div class="w-full max-w-md">
            <h2 class="text-2xl font-bold mb-8 text-gray-800">App e-Letter_BK</h2>
            <div class="mb-6 text-sm uppercase text-gray-700">
<div class="mb-8 text-sm uppercase text-blue-700">
  <p class="font-bold uppercase mb-3">
    SELAMAT DATANG WALI PENDAMPING KELAS
  </p>

  <ul class="list-disc list-inside space-y-1 text-xs">
    <li>Bapak Afton Ilman Huda Mdk. (Kelas 7C)</li>
    <li>Ibu Monicha Dewi Lestari (Kelas 7D)</li>
    <li>Bapak Eko Dainur Utomo Pasi (Kelas 7E)</li>
    <li>Bapak Maret E. Siburian (Kelas 7F)</li>
    <li>Bapak Syaiful Bahri (Kelas 7G)</li>
  </ul>
</div>
</div>
            </div>
            <div class="space-y-4">
                <input id="user" type="text" placeholder="Username" class="w-full border p-3 rounded-lg">
                <input id="pass" type="password" placeholder="Password" class="w-full border p-3 rounded-lg">
                <button onclick="handleLogin()" id="btnLogin" class="w-full bg-black text-white py-3 rounded-lg font-bold hover:bg-gray-800">LOGIN</button>
                <p id="loginError" class="text-red-600 text-sm hidden">Username atau password salah</p>
            </div>
            <footer class="mt-8 text-center text-black-400 text-sm font-bold">© 2026 DEVELOPED by GALIH MGBK SMP</footer>
        </div>
    </div>
</div>

<div id="appPage" class="hidden h-screen flex flex-col overflow-hidden">
    <header class="bg-white border-b px-4 py-3 flex justify-between items-center shadow-sm z-50">
        <div class="flex items-center gap-2 font-bold text-lg"><span class="bg-black text-white px-2 rounded">&lt;/Gr.&gt;</span> e-Letter_BK</div>
        <button onclick="location.reload()" class="text-red-600 font-semibold text-sm flex items-center gap-1 hover:bg-red-50 p-2 rounded">
            <i data-lucide="log-out" class="w-4 h-4"></i> Keluar
        </button>
    </header>

    <main class="flex-1 flex flex-col md:flex-row overflow-hidden p-2 gap-2">
        <div class="w-full md:w-[400px] bg-white p-4 rounded-xl shadow-md border flex flex-col gap-4 overflow-y-auto no-print">
            <h3 class="font-bold border-b pb-2 text-sm flex items-center gap-2"><i data-lucide="file-text" class="w-4 h-4"></i> FORM PENGISIAN</h3>
            
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-gray-500 uppercase">Kop Surat</label>
                <input type="file" id="inputKop" accept="image/*" class="text-xs w-full border p-1 rounded">
            </div>
    <p class="text-[10px] text-black-500 mt-1">
        Silahkan download Kop Surat untuk digunakan pada aplikasi ini melalui tautan 
        <a href="https://shorturl.at/5lI4d" target="_blank" class="text-blue-600 underline hover:text-blue-800">
            https://shorturl.at/5lI4d
        </a>
    </p>
            <div class="grid grid-cols-2 gap-2">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-gray-500 uppercase">Tanggal Surat</label>
                    <input type="date" id="tglSurat" onchange="updatePreview()" class="w-full border p-2 rounded text-xs">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-gray-500 uppercase">Tanggal Kehadiran Tamu</label>
                    <input type="date" id="tglHadir" onchange="updatePreview()" class="w-full border p-2 rounded text-xs">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-gray-500 uppercase">Waktu</label>
                    <select id="waktu" onchange="updatePreview()" class="w-full border p-2 rounded text-xs">
                        <option value="">-- Pilih --</option>
                        <option>08.00 WITA</option><option>08.30 WITA</option><option>09.00 WITA</option>
                        <option>09.30 WITA</option><option>10.00 WITA</option><option>11.00 WITA</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-gray-500 uppercase">Lokasi</label>
                    <select id="lokasi" onchange="updatePreview()" class="w-full border p-2 rounded text-xs">
                        <option value="">-- Pilih --</option>
                        <option>Ruang Bimbingan dan Konseling</option>
                        <option>Ruang Olahraga</option>
                        <option>Ruang Kepala Sekolah</option>
                    </select>
                </div>
            </div>

            <div class="space-y-1">
                <label class="text-[10px] font-bold text-gray-500 uppercase">Kelas</label>
                <select id="selectKelas" onchange="loadMurid()" class="w-full border p-2 rounded text-xs"></select>
            </div>

            <div class="space-y-1">
                <label class="text-[10px] font-bold text-gray-500 uppercase">Nama Murid</label>
                <select id="selectMurid" onchange="updatePreview()" class="w-full border p-2 rounded text-xs" disabled>
                    <option value="">Pilih Kelas Dulu</option>
                </select>
            </div>

<div class="space-y-1">
    <label class="text-[10px] font-bold text-gray-500 uppercase">Pa / Pi</label>
    <select id="selectPaPi" onchange="updatePreview()" class="w-full border p-2 rounded text-xs">
        <option value="">-- Pilih Pa / Pi --</option>
        <option value="PUTRA">Putra</option>
        <option value="PUTRI">Putri</option>
    </select>
</div>

            <div class="space-y-1">
                <label class="text-[10px] font-bold text-gray-500 uppercase">Wali Pendamping</label>
                <select id="selectWali" onchange="updatePreview()" class="w-full border p-2 rounded text-xs"></select>
            </div>

            <div class="pt-2 border-t">
                <label class="text-[10px] font-bold text-gray-400 uppercase mb-2 block">Tampilkan Tanda Tangan</label>
                <div id="checkWali" class="grid grid-cols-2 gap-2 p-2 bg-gray-50 rounded border"></div>
            </div>

<p class="text-[10px] font-bold text-red-600 mb-1 italic">
        * Klik Sudah Ok dulu, baru lanjut klik Unduh
    </p>

<div class="mt-auto flex gap-2">
 <button onclick="handleSendEmail(event)" 
        class="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold text-sm hover:bg-green-700 transition">
    Sudah OK
</button>
    <button id="btnUnduh" onclick="downloadPDF()" class="flex-1 bg-gray-400 text-white py-3 rounded-lg font-bold text-sm cursor-not-allowed transition" disabled>Unduh</button>
</div>
        </div>

        <div class="flex-1 bg-gray-500 p-2 overflow-x-auto overflow-y-auto flex justify-center">
            <div class="cert-preview-scale">
                <div id="suratContent" style="width:210mm; height:330mm; background:white; padding:15mm; box-sizing:border-box;">
                    <div id="kopArea" style="height: 35mm; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        <div class="text-gray-300 italic">UNGGAH KOP SURAT</div>
                    </div>
                    <div style="border-top: 3pt double black; margin: 10px 0 20px 0;"></div>

                    <h3 style="text-align: center; font-weight: bold; text-decoration; margin-bottom: 20px;">SURAT PEMANGGILAN ORANG TUA / WALI MURID</h3>
                    
                    <div style="text-align: right; margin-bottom: 20px;">BALIKPAPAN, <span id="prevTglSurat">..........</span></div>

<div style="margin-bottom: 20px; line-height: 1.6;">
    <table style="width: 100%; border-collapse: collapse;">
        <tr>
            <td style="width: 85px; vertical-align: top;">Perihal</td>
            <td style="width: 15px; vertical-align: top;">:</td>
            <td><b>UNDANGAN</b></td>
        </tr>
        <tr>
            <td style="width: 110px; vertical-align: top;">Kepada Yth</td>
            <td style="width: 15px; vertical-align: top;">:</td>
            <td>
                <b>ORANG TUA / WALI</b><br>
                a.n. <b id="prevNamaMurid">....................</b><br>
                KELAS <b id="prevKelas">....</b><br>
                di -<br>
                <span style="margin-left: 30px;">Tempat</span>
            </td>
        </tr>
    </table>
</div>

<p style="
    text-indent: 40px;
    text-align: justify;
    line-height: 2.2;
    margin-bottom: 20px;
">
    Sehubungan dengan adanya perkembangan dan informasi mengenai
    <b id="prevNamaMuridNarasi">....................</b>
    sebagai
    <b id="prevPaPi">......</b>
    dari Bapak/Ibu yang perlu disampaikan dan/atau dikoordinasikan selaku murid
    di lingkungan SMP Negeri 15 Balikpapan, maka kami turut mengundang Bapak/Ibu
    untuk hadir pada:
</p>

<table style="margin: 0 auto 20px auto; width: 80%; border-collapse: collapse;">
    <tr>
        <td width="100" style="padding:6px 0 6px 120px;">Hari</td>
        <td width="15" style="text-align:center; padding:8px 0;">:</td>
        <td style="padding:6px 0;"><b id="prevHariH">..........</b></td>
    </tr>
    <tr>
        <td style="padding:6px 0 6px 120px;">Tanggal</td>
        <td style="text-align:center; padding:8px 0;">:</td>
        <td style="padding:6px 0;"><b id="prevTglH">..........</b></td>
    </tr>
    <tr>
        <td style="padding:6px 0 6px 120px;">Waktu</td>
        <td style="text-align:center; padding:8px 0;">:</td>
        <td style="padding:6px 0;"><b id="prevWaktu">..........</b></td>
    </tr>
    <tr>
        <td style="padding:6px 0 6px 120px;">Tempat</td>
        <td style="text-align:center; padding:8px 0;">:</td>
        <td style="padding:6px 0;"><b id="prevLokasi">..........</b></td>
    </tr>
</table>

                    <p style="text-indent: 40px; text-align: justify; line-height: 2.2; margin-bottom: 40px;">
                        Mengingat pentingnya undangan ini, maka dimohon kepada bapak/ibu agar bersedia hadir tepat waktu. Demikian undangan ini disampaikan. Atas perhatian dan kerjasamanya, kami mengucapkan terima kasih.
                    </p>
<div style="text-align: center; font-weight: bold; margin-bottom: 10px; font-size: 16px;">
    MENGETAHUI,
</div>
                    <div style="display: flex; justify-content: space-between; text-align: center">
                        <div style="width: 45%;">
                            <p id="prevJabatanWali" style="font-weight: bold;">WALI PENDAMPING</p>
                            <div id="prevSignWali" style="height: 80px; display: flex; align-items: center; justify-content: center;"></div>
                            <p><b id="prevNamaWali" style="white-space: nowrap;">....................</b></p>
                            <p id="prevNipWali" style="font-weight: bold;">NIP. ....................</p>
                        </div>
                        <div style="width: 45%; margin-left: 50px;">
                            <p id="prevJabatanBK" style="font-weight: bold;">KONSELOR KELAS</p>
                            <div style="height: 80px; display: flex; align-items: center; justify-content: center;">
                                <img src="https://i.postimg.cc/v16NmcGV/GALIH.png" style="max-height: 100%;">
                            </div>
                            <p><b style="text-decoration">Gr. GALIH ATMAJI, S.Pd.</b></p>
                            <p><b style="font-bold">NIP. 199305242019031009</p>
                        </div>
                    </div>
<div style="margin-top: 30px; text-align: left; font-size: 10px; line-height: 1.3; color: #333;">
    <p style="font-weight: bold; margin-bottom: 2px;">Tembusan :</p>
    <table style="border-collapse: collapse; margin-left: 5px;">
        <tr>
            <td style="vertical-align: top; padding-right: 5px;">1.</td>
            <td>Kepala SMP Negeri 15 Balikpapan</td>
        </tr>
        <tr>
            <td style="vertical-align: top; padding-right: 5px;">2.</td>
            <td>Koordinator Kesiswaan</td>
        </tr>
    </table>
</div>
                </div>                
            </div>
        </div>
    </main>
</div>

<script>
// --- DATABASE ---
    const DATA_MURID = {
        'Kelas 7C': ['AFI FAADHIL', 'ALDINO GHOZY AFWAN', 'ALZAHRAH TRIVA MAISYA', 'AMMAR RIFA\'I', 'ANDIEN RURI OCTAVINNIA', 'ATIQAH RAIHANAH BATUBARA', 'DELLA JUANITA PURNAMA', 'DEVA HIDAYAH TRYANTO', 'ERSYIFA HUMAIRA KAYANA', 'ERVINA TIARAMADHANI', 'FITA NAURAH DAHLIANSIH', 'HUSNUL KHOTIMAH', 'INDAH FERTINA', 'IQRA RESTU BAIHAQI', 'KANIA ATHIFAH RAMADHANI', 'MOHAMMAD FAREL ABDILLAH', 'MUHAMAD MARDAN WABULA', 'MUHAMMAD FADHIL PRATAMA', 'MUHAMMAD REZA AL-FATTAH', 'MUHAMMAD RIZQY AISY', 'MUHAMMAD ZAFIR AL AUFAR IMANSYAH', 'NAYSA ATHIFA ARSYAKYLA', 'NEYSA ELEANOR QUINNOVA', 'NUR AISYAH AQILLA', 'NUR ZAHRA', 'OVALE KASTARA WARDANA', 'RAYYN IZZABAH ROHIM', 'REYCHAL PRATAMA', 'RIO ADRIAN', 'RIZAL NUR EFFENDY', 'RULIAVYTA KHANZA PUTRI', 'SALWA NAYSILA AZZAHRA', 'SHAQILA AHDA KHANAYA', 'SULTAN MUHAMMAD RAFIF', 'ZALFA HAURAJINGGA PUTU RINTANI'],
        'Kelas 7D': ['ABRAR HAMID', 'AFIQA BILQIS HUFAIDA', 'AHMAD RAFLI ADITYA', 'AISHA AZZAHRA', 'AL FIANDRA AMALUL FADLY', 'ALISYA ZAFARANI', 'AMIRUL HAQ', 'AZKA RAFIFAH ARTANTI', 'CAHAYA RUBY', 'DAFFA ZIDANNE PRIYO', 'DZAKY RAFA RADINKA SETYAWAN', 'EKA DWI RAMDANI ISMAIL', 'ELSA OKTAVIANI', 'GLADYSIA SHAKILLA AZ-ZAHRAA', 'ISRO\' NAFA MAHRISYA', 'JENY AULIA PUTRI', 'KHAISAR BRILLIANO PUTRA', 'KHAYLA AZMI ATHIFA', 'LISKY', 'LUTHFI KIANDRA ALFAREZI', 'MARIAM', 'MASHITHOH KISWOYO', 'MOH BACKTYAR CORBIANSYAH', 'MUHAMMAD AMIN BALADI', 'MUHAMMAD DZAKI DZUL HANNAN', 'MUHAMMAD KEYSHA WIDIYONO PUTRA', 'NAUFAL ALFAROZY', 'NIHAYATUL HUSNA', 'PUTRI ALANA', 'QUEENSHA ARIANNA', 'RADIVA AGNI WULANDARIE', 'REVINDRA ARJUNA VIYOGA', 'RIZKY YADI RAHMADANI', 'SATRIA YUDHA ARIF PRATAMA', 'ZAHRA PUTRI APRILIA'],
        'Kelas 7E': ['AHMAD GHIFARI RIADI', 'AL MALIQI IBROHIM', 'ALDRIAN JOEL LEVINE SIMORANGKIR', 'ALIF AMALZA PUTRA', 'ALVIS TRIENGSIH', 'ANDIKA PRASTIYA DEWA', 'ARFA ADI NATA', 'ARSYA ADITYA', 'ARZIKI PRATAMA HARDIYANTO', 'AULIA RAHMAH', 'AZFAR AZIZAN', 'BARATA ALI MUSTOFA GINA', 'BUNGA MUTIARA FARADILLA', 'CINDY NUR CAMELIA', 'DZAKY ALTAF', 'EKA PUTRI RAHAYU SEPTIANINGSIH', 'FAJIRA', 'FAUZIYYAH NEIDINA', 'GUSTI AYU PUTRI BEIBY ANGEL WIENATA', 'ILHAM', 'KAYLA TRI ANDJANI', 'KHARIN ELMEYRA PUTRI', 'KIRANA MARELLA SYAIFUL', 'MEYSYA SARI PRAMUDYA', 'MUHAMMAD AZUAN HELMI LABIB', 'MUHAMMAD FAHMI', 'MUHAMMAD NUR RIHANSYAH', 'NABILA CHOIRUNISA', 'NOVITA SALLY POLII', 'NUR WULAN RIZKIA', 'RISKA SEPTIANI', 'RIZKA LAILLA RAMADHANI', 'SALSABILA HUMAIRAH', 'SANJAYA MUHAMMAD SYAH NAQSYABANDI', 'VIVI ALIDYA SULIANTO'],
        'Kelas 7F': ['AFIFAH SAYYIDAH', 'AHMAD NIZHER SYAIROZY', 'AIYANA FARRAS GWENELDA', 'ALIEF GHUMALAN ZAKIYA', 'ALISYAH INDRIANI PUTRI', 'AQILLA AZ ZAHRAH', 'ARINA MANASIKANA', 'ASYRAF KHAIRUL AZAM', 'CAMELIA NUR AINI', 'DAFFA ABDUL RAZAQ', 'DIVA ZASKIA SYAZANA HAFFAFA', 'EDWARD SANDER ARIFIN', 'ENCI MUHAMMAD GIBRAN QAID', 'FAEYZA KARIM AL FATIH LAHIYA', 'KENZIE JAVAS NISCALA', 'KEYLA APRIENSYA RIDWAN', 'KUBIMA ZAKI', 'LYANA ZAHIRA', 'MAULANA AHNAF BAHIRULLOH', 'MOCHAMAD ANGGA SATRIA', 'MUHAMMAD ABDUL FATTAH', 'MUHAMMAD DAFFA', 'MUHAMMAD RIFQI ARIANSYAH', 'NADYA AMALIYAH ZAIDAH', 'NATASYAH AINUN SORAYA', 'NAUVAL DIAZ AINUN RIZKY', 'NUR AURELIA ALMAS', 'RAHMA WATI', 'RAZQA SHIDQI AL FAKHRI', 'RIZKY TANIA ZHAFIRA', 'SARAH MAHIRUNISA', 'SHERLY', 'YASMIN NAILA AZ ZAHRA', 'ZASKIA ANYTA FITRIANI SURATMANTO'],
        'Kelas 7G': ['ALEXA GAYA NATA', 'ALYA NUR ROHMAH', 'AMIRA NUR FARIHA', 'ANINDITA NABILA ZAKRO', 'AUFAR GIONINO MOCHTAR', 'AULVIA KHUMAIRAH', 'CHELSEA NAERA', 'DIRA SALSABILA RAHMADI', 'ENZO ZAVIER ALFARISQI', 'ERLITA RAFANI MUSLIM', 'FAEYZA NAUFAL PUTRA HARISANDY', 'IBRAHIM DAFFA AMRIZAL', 'IFA KHOIRUNNISA', 'INDRIANI NUR HABIBAH', 'JIO ZAFRAN ALVARO', 'KAILA CANDRA NENGTYAS', 'LUTVIANA NUROHMAH', 'MAHIJA ATHAILLAH HERARIA', 'MAULANA ADITYA PUTRA YULIANTO', 'MUHAMMAD FAYAADH', 'MUHAMMAD NADIR WELDY SUKARDI', 'MUHAMMAD NAZAM SOGI ALVIAN', 'MUHAMMAD RIFKY SHAPUTRA', 'MUHAMMAD RIZKY AL-AZAM', 'NADYA AULIA AL-ZAHRA', 'NAJHATA ENGGAR SUBANDI', 'NAYLA PUTRI RAMADHANI', 'PRABU PUTRA PEMBAYUN', 'RESTU ZHAVIER AL-MUHAJIR', 'REVALIQA AZZAHRA', 'RIZKY PUTRI ARIYANTI', 'SALSABILA UMMI AZAHRA', 'SATYA BAYU AJI', 'VIANA ARIFANI', 'YOGA DANISH ATHA NOOR']
    };

    const WALI_DATA = {
        'AFTON ILMAN HUDA MAHARDHIKA, S.Pd.': { nip: '199508172024211019', sign: 'https://i.postimg.cc/JsFFmbCK/AFTON.png', short: 'afton', label: 'Bapak Afton' },
        'MONICHA DEWI LESTARI, S.Pd.': { nip: '199702202023212012', sign: 'https://i.postimg.cc/mcF5rtTN/MONIC.png', short: 'monic', label: 'Ibu Monic' },
        'EKO DAINUR UTOMO PASI, S.Pd.': { nip: '198812222022211003', sign: 'https://i.postimg.cc/KKgHYRmL/EKO.png', short: 'eko', label: 'Bapak Eko' },
        'MARET E.SIBURIAN, S.Pd.': { nip: '199503282023211007', sign: 'https://i.postimg.cc/sBZN2v3W/MARET.png', short: 'maret', label: 'Bapak Maret' },
        'SYAIFUL BAHRI, M.Pd.': { nip: '199603232023211003', sign: 'https://i.postimg.cc/p9n6dpPJ/SYAIFUL.png', short: 'syaiful', label: 'Bapak Syaiful' }
    };

    const MONTHS = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
    const DAYS = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];

    lucide.createIcons();

    async function handleLogin() {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        const btn = document.getElementById('btnLogin');
        const err = document.getElementById('loginError');
        btn.innerText = "Memproses...";
        try {
            const res = await fetch("https://script.google.com/macros/s/AKfycbyAKHATMdMNomO3DFMxwGg2cZfc0dwYFjctQbBGnBRcPg_P7pLGE7F1vUBidT_6iQTrQQ/exec", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ username: u, password: p })
            });
            const data = await res.json();
            if (data.status === "success") {
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('appPage').classList.remove('hidden');
                initApp();
            } else { err.classList.remove('hidden'); }
        } catch { alert("Gagal koneksi ke server"); }
        btn.innerText = "LOGIN";
    }

    function initApp() {
        const sKelas = document.getElementById('selectKelas');
        sKelas.innerHTML = '<option value="">-- Pilih Kelas --</option>' + 
            Object.keys(DATA_MURID).map(k => `<option value="${k}">${k}</option>`).join('');

        const sWali = document.getElementById('selectWali');
        sWali.innerHTML = '<option value="">-- Pilih Wali --</option>' + 
            Object.keys(WALI_DATA).map(w => `<option value="${w}">${w}</option>`).join('');

        const cWali = document.getElementById('checkWali');
        cWali.innerHTML = Object.values(WALI_DATA).map(v => `
            <label class="flex items-center gap-1 text-[10px] cursor-pointer">
                <input type="checkbox" id="check-${v.short}" 
                       onchange="handleCheckboxChange(this); updatePreview()" 
                       class="wali-checkbox scale-75"> ${v.label}
            </label>
        `).join('');
    }

    function handleCheckboxChange(selectedCheckbox) {
        const checkboxes = document.querySelectorAll('.wali-checkbox');
        if (selectedCheckbox.checked) {
            checkboxes.forEach(cb => { if (cb !== selectedCheckbox) cb.disabled = true; });
        } else {
            checkboxes.forEach(cb => { cb.disabled = false; });
        }
    }

    function loadMurid() {
        const k = document.getElementById('selectKelas').value;
        const sMurid = document.getElementById('selectMurid');
        const btnUnduh = document.getElementById('btnUnduh');

        btnUnduh.disabled = true;
        btnUnduh.classList.add('bg-gray-400', 'cursor-not-allowed');
        btnUnduh.classList.remove('bg-blue-600', 'hover:bg-blue-700');

        if(!k) { sMurid.disabled = true; return; }
        sMurid.disabled = false;
        sMurid.innerHTML = '<option value="">-- Pilih Nama --</option>' + 
            DATA_MURID[k].map(m => `<option value="${m}">${m}</option>`).join('');
        updatePreview();
    }

    function formatDate(dateStr) {
        if(!dateStr) return null;
        const d = new Date(dateStr);
        return {
            full: `${DAYS[d.getDay()]}, ${d.getDate()} ${MONTHS[d.getMonth()]} ${d.getFullYear()}`,
            day: DAYS[d.getDay()],
            date: `${d.getDate()} ${MONTHS[d.getMonth()]} ${d.getFullYear()}`
        };
    }

    function updatePreview() {
        const val = (id) => document.getElementById(id).value;
        const dS = formatDate(val('tglSurat'));
        const dH = formatDate(val('tglHadir'));
        const waliName = val('selectWali');
        const wali = WALI_DATA[waliName];
        
        document.getElementById('prevTglSurat').innerText = dS ? dS.date.toUpperCase() : '..........';
        document.getElementById('prevNamaMurid').innerText = val('selectMurid') || '....................';
        
        const kelasRaw = val('selectKelas');
        const kelas = kelasRaw ? kelasRaw.replace('Kelas ', '') : '';
        document.getElementById('prevKelas').innerText = kelas || '....';
        document.getElementById('prevHariH').innerText = dH ? dH.day.toUpperCase() : '..........';
        document.getElementById('prevTglH').innerText = dH ? dH.date.toUpperCase() : '..........';
        document.getElementById('prevWaktu').innerText = val('waktu') ? val('waktu') + ' s.d. Selesai' : '..........';
        document.getElementById('prevLokasi').innerText = val('lokasi') ? val('lokasi').toUpperCase() : '..........';
        document.getElementById('prevJabatanWali').innerText = kelas ? `WALI PENDAMPING KELAS ${kelas}`.toUpperCase() : 'WALI PENDAMPING';
        document.getElementById('prevJabatanBK').innerText = kelas ? `KONSELOR KELAS ${kelas}`.toUpperCase() : 'KONSELOR KELAS';
        document.getElementById('prevNamaMuridNarasi').innerText = val('selectMurid') || '....................';
        document.getElementById('prevPaPi').innerText = val('selectPaPi') || '......';
        document.getElementById('prevNamaWali').innerText = waliName || '....................';
        document.getElementById('prevNipWali').innerText = wali ? 'NIP. ' + wali.nip : 'NIP. ....................';

        const signArea = document.getElementById('prevSignWali');
        signArea.innerHTML = '';
        Object.values(WALI_DATA).forEach(v => {
            const cb = document.getElementById(`check-${v.short}`);
            if(cb && cb.checked) {
                signArea.innerHTML = `<img src="${v.sign}" style="max-height: 100%; mix-blend-multiply: multiply;">`;
            }
        });
    }

    document.getElementById('inputKop').onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const r = new FileReader();
            r.onload = (ev) => document.getElementById('kopArea').innerHTML = `<img src="${ev.target.result}" style="width:100%; height:100%; object-fit:contain;">`;
            r.readAsDataURL(file);
        }
    };

async function downloadPDF() {
    const btn = document.getElementById('btnUnduh');
    const originalText = btn.innerText;

    btn.innerText = "Menyiapkan...";
    btn.disabled = true;
    btn.classList.add('bg-gray-400', 'cursor-not-allowed');
    btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');

    const element = document.getElementById('suratContent');
    const kelasRaw = document.getElementById('selectKelas').value || 'TANPA KELAS';
    const kelas = kelasRaw.replace('Kelas ', '').trim();
    const nama = document.getElementById('selectMurid').value || 'SURAT';
    const tglSuratRaw = document.getElementById('tglSurat').value;

    let bulan = "BULAN", tahun = "2026";
    if (tglSuratRaw) {
        const d = new Date(tglSuratRaw);
        bulan = MONTHS[d.getMonth()].toUpperCase();
        tahun = d.getFullYear();
    }

    const namaFile = `${kelas}_${nama}_${bulan}_${tahun}`.toUpperCase();
    const isMobile = window.innerWidth < 768;

    const opt = {
        margin: [0, 0, 0, 0],
        image: { type: 'jpeg', quality: 1 },
        html2canvas: {
            scale: isMobile ? 1 : 2,
            useCORS: true,
            logging: false,
            windowWidth: 794,
            windowHeight: 1240
        },
        jsPDF: {
            unit: 'mm',
            format: [210, 330],
            orientation: 'portrait',
            compress: true
        },
        pagebreak: { mode: ['avoid-all'] }
    };

    try {
        await html2pdf()
            .set(opt)
            .from(element)
            .save(namaFile + ".pdf");

        btn.innerText = "Dokumen Selesai ✔";
        setTimeout(() => {
            btn.innerText = originalText;
            btn.disabled = false;
            btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }, 2000);

    } catch (err) {
        alert("Gagal membuat PDF");
        console.error(err);
        btn.innerText = originalText;
        btn.disabled = false;
    }
}

    async function handleSendEmail(event) {
        const btn = event.currentTarget;
        const btnUnduh = document.getElementById('btnUnduh');
        const originalText = btn.innerText;
        const element = document.getElementById('suratContent');

        const kelasRaw = document.getElementById('selectKelas').value || 'TANPA KELAS';
        const kelas = kelasRaw.replace('Kelas ', '').trim();
        const nama = document.getElementById('selectMurid').value || 'SURAT';
        const tglSuratRaw = document.getElementById('tglSurat').value;

        let bulan = "BULAN", tahun = "2026";
        if (tglSuratRaw) {
            const d = new Date(tglSuratRaw);
            bulan = MONTHS[d.getMonth()].toUpperCase();
            tahun = d.getFullYear();
        }
        const namaFile = `${kelas}_${nama}_${bulan}_${tahun}.pdf`.toUpperCase();

if (
    !document.getElementById('selectKelas').value ||
    !document.getElementById('selectMurid').value ||
    !document.getElementById('tglSurat').value ||
    !document.getElementById('tglHadir').value
) {
    alert("Lengkapi data terlebih dahulu sebelum klik Sudah OK.");
    return;
}

        btn.innerText = "Mengunggah...";
        btn.disabled = true;

        try {
const isMobile = window.innerWidth < 768;
const opt = {
    margin: 0,
    image: { type: 'jpeg', quality: 1 },
    html2canvas: {
        scale: isMobile ? 1 : 2,
        useCORS: true,
        logging: false
    },
    jsPDF: {
        unit: 'mm',
        format: [210, 330],
        orientation: 'portrait',
        compress: true
    },
    pagebreak: false
};

            const pdfBase64 = await html2pdf().set(opt).from(element).outputPdf('datauristring');
            const base64Content = pdfBase64.split(',')[1];
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzkMGNRrRWsJOujv0blmcP2D_-OtGbI-Xrb6tceF6psQQLfHACYx3Eyhik-zpruJO0PqA/exec";

            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ fileData: base64Content, fileName: namaFile })
            });

            alert("Berhasil! Lanjutkan Unduh.");
            btnUnduh.disabled = false;
            btnUnduh.classList.remove('bg-gray-400', 'cursor-not-allowed');
            btnUnduh.classList.add('bg-blue-600', 'hover:bg-blue-700');

        } catch (error) {
            console.error(error);
            alert("Gagal melakukan backup: " + error.message);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
